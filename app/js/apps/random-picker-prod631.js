var app=new Vue({el:"#rpp-app",i18n:Vue_I18N,mixins:[CommonMixin],data:{lines:[],preview:[],totalLines:0,totalUniqueLines:0,freeLimit:2e4,filename:null,config:{has_headers:!1,main_field:0,display_field:0,has_delimiter:!1,delimiter:",",title:"",new_title:"",filename:null,source:null},saving:{total:0,saved:0,percent:0},form:{title:"",textarea:""},errors:{title:!1,textarea:!1},file_import:{loaded:!1,data:null,lines:[],lines_preview:[],has_delimiter:!1,has_headers:!1,preview:"",columns:[],column_index:0},previewData:[],giveaway:null,checkout_url:null,loading:!1,editing:!1,modal:null,onInput:null,premiumEventSent:!1,type:"free"},mounted:function(){$("#vue-loader").remove(),this.onInput=this.debounce(this.updateCount,300)},created:function(){this.modal=$("#uploadFileModal"),SHARED_DATA.giveaway?(this.giveaway=SHARED_DATA.giveaway,this.checkout_url=SHARED_DATA.checkout_url,this.config.title=this.giveaway.title):this.editing=!0},methods:{onImportFromFile:function(){this.lines=[],this.preview=[],$("#uploadFileModal").modal()},onFileSelected:function(files){this.readFile(files)},readFile:function(files){var t,_this=this;this.loading=!0,files.length&&(t=files[0],new FileReader,files=files[0],this.readLargeTextFile(files,3145728,function(lines){null!==lines?Array.isArray(lines)&&(lines=lines.map(function(line){return line.replace(/['"]+/g,"")}).filter(function(line){return""!==line}),_this.file_import.lines=_this.file_import.lines.concat(lines),console.log("reading lines",_this.file_import.lines.length)):(console.log("Lectura del archivo completa."),_this.onFileLinesReaded())}),this.file_import.file=t)},readLargeTextFile:function(file,chunkSize,callback){const reader=new FileReader;let leftoverData="",bytesRead=0;reader.onload=function(event){var end;event.target.result&&(event=event.target.result,bytesRead+=event.byteLength,event=new Uint8Array(event),event=(leftoverData+(new TextDecoder).decode(event)).split("\n"),leftoverData=event.pop(),callback(event),event=bytesRead,end=Math.min(file.size,event+chunkSize),event<file.size?(event=file.slice(event,end),reader.readAsArrayBuffer(event)):(callback([leftoverData]),callback(null)))};var blob=file.slice(0,chunkSize);reader.readAsArrayBuffer(blob)},onFileLinesReaded:function(){this.file_import.has_delimiter=this.checkLineSeparators(),this.file_import.columns=this.getColumns(),this.file_import.loaded=!0,this.loading=!1},onFileLoaded:function(e){this.file_import.data=e.target.result,this.file_import.lines=this.file_import.data.split("\n").map(function(line){return line.replace(/['"]+/g,"")}).filter(function(line){return""!==line}),this.file_import.has_delimiter=this.checkLineSeparators(),this.file_import.columns=this.getColumns(),this.file_import.loaded=!0,this.loading=!1},cancelImport:function(){this.file_import={loaded:!1,data:null,lines:[],lines_preview:[],has_delimiter:!1,preview:"",columns:[],column_index:0}},onDeleteFile:function(){this.cancelImport(),this.totalLines=0,this.form.textarea="",this.lines=[],this.filename=null},onOpenFileSettings:function(){this.openModal("fileSettingsModal")},generatePreview:function(){var column_index;this.file_import.columns.length?(column_index=this.file_import.column_index,this.lines=this.file_import.lines.filter(function(line){return""!==line.trim()}).map(function(item){return-1===column_index?item.split(",").join(" "):(item=item.split(",")).length&&item[column_index]?item[column_index].trim():item[0]})):this.lines=this.file_import.lines,this.file_import.has_headers&&this.lines.shift(),this.totalLines=this.lines.length,this.form.textarea=this.lines.slice(0,5).join("\n"),this.form.textarea+="\n",this.form.textarea+="\n",this.form.textarea+=". . . . . .",this.form.textarea+="\n",this.form.textarea+="\n",this.form.textarea+=this.lines.slice(-1),this.filename=this.file_import.file.name,this.updateCount()},getColumns:function(){return this.file_import.has_delimiter?this.file_import.lines[0].split(","):[]},onColumnSelected:function(){this.generatePreview()},onImportDone:function(e){this.generatePreview(),this.hideModal("uploadFileModal")},checkLineSeparators:function(){var hasCommas=!0;for(i=1;i<10;i++)this.lines[i]&&-1===this.lines[i].indexOf(",")&&(hasCommas=!1);return console.log("checkLineSeparators",hasCommas),hasCommas},onPaste:function(e){var lines_count=e.clipboardData.getData("text").split("\n");this.totalLines=lines_count.length,lines_count.length>this.freeLimit&&(this.showUseFileWarning(),e.preventDefault(),delete lines_count,this.totalLines=0)},showUseFileWarning:function(){this.toast(this.$t("notifications.limit_reach_use_file"),"error")},validate:function(){var result=!0;return(!this.form.title||this.form.title.length<3)&&(this.errors.title=!0,this.toast(this.$t("random_picker.error_invalid_title"),"error",2e3),result=!1),this.totalLines<2&&(this.errors.textarea=!0,this.toast(this.$t("random_picker.error_invalid_entrants"),"error",2e3),result=!1),result},onContinue:function(){return!!this.validate()&&(this.totalLines>this.freeLimit&&!this.filename?(this.showUseFileWarning(),!1):this.user||"premium"!==this.type?"premium"===this.type?(this.showConfirm(this.$t("buttons.confirm"),this.$t("random_picker.confirm_save"),this.$t("buttons.continue"),this.onSaveGiveaway),!1):void("free"===this.type&&redirectPost("/"+SHARED_DATA.locale+"/app",{type:"random-name",title:this.form.title,participants:this.file_import.loaded?this.lines.map(function(line){return line.replace(/['"]+/g,"")}).join("\n"):this.form.textarea.replace(/['"]+/g,"")})):this.openModal("authModal"))},onSaveGiveaway:function(){var request_url="/api/giveaways/create",request_method="POST",data={id:this.giveaway&&this.giveaway.id,type:"random-name",title:this.form.title,total_participants:this.totalLines,original_filename:this.filename||""};this.giveaway&&this.giveaway.id&&(request_url=endpoint="/api/giveaways/update",request_method="PUT"),this.openModal("savingEntrantsModal"),this.loading=!0,$.ajax({url:request_url,method:request_method,data:data,dataType:"json"}).done(this.onGiveawayCreated).fail(this.onSaveFail)},getFileEntries:function(){return this.filename?this.lines:this.form.textarea.split("\n")},onGiveawayCreated:function(r){console.log(r),this.giveaway=r.data,this.onSaveEntrants()},onSaveEntrants:function(){var _this=this,entries=this.getFileEntries(),per_page=5e3,pages=Math.ceil(entries.length/per_page),requests=0,total_entries=entries.length,callSave=function(){var pagination_start=requests*per_page,pagination_end=pagination_start+per_page;$.ajax({url:"/api/giveaways/add-entries",method:"PUT",dataType:"json",data:{id:_this.giveaway.id,page:requests+1,pages:pages,entries:JSON.stringify(entries.slice(pagination_start,pagination_end))},success:function(response){requests++,_this.saving.total=total_entries,_this.saving.saved=total_entries<pagination_end?total_entries:pagination_end,_this.saving.percent=Math.round(_this.saving.saved/_this.saving.total*100),requests<pages?callSave():_this.onSaveEntrantsFinished()}})};callSave()},onSaveEntrantsFinished:function(){mixpanel.track("AS_ListGiveawayPremiumSaved"),this.goToCheckout()},onUserSignup:function(event){$(".hide-logged-in").hide(),$(".show-logged-in").show(),$(".user-picture").attr("src",event.user.picture),this.setUser(event.user)},onUserLogin:function(event){console.log(event),this.hideModal("authModal"),$(".hide-logged-in").hide(),$(".show-logged-in").show(),$(".user-picture").attr("src",event.user.picture),this.setUser(event.user),this.toast(this.$t("notifications.success_login"),"success")},onChange:function(event){var event=event.target.value,t=this.getWords(event),r=this.getParagraphs(event).length,n=this.filterDuplicateItems(t).length,i=(t.length,event.length,this.getCharactersWithoutSpaces(event));this.cc=event.length,this.wc=t.length,this.pc=r,this.uwc=n,this.cws=i},filterDuplicateItems:function(r){return r.filter(function(e,t){return r.indexOf(e)===t})},uploadFile:function(e){var _this=this,fileInput=$("#js-sorteados-file"),data=new FormData;$.each(fileInput[0].files,function(i,file){data.append("file-"+i,file),_this.config.file=file}),this.loading=!0,$.ajax({url:"/api/xlsx/columns",data:data,cache:!1,contentType:!1,processData:!1,dataType:"json",method:"POST"}).done(this.onFileUploaded).fail(this.onFileUploadedFailed)},toggleHeader:function(e){this.hideHeader?this.preview=this.lines.slice(1,5):this.preview=this.lines.slice(0,4)},autoDetectConfig:function(){var hasDelimiter=-1<this.entrants[1].indexOf(this.config.delimiter),firstEntrant=this.entrants[0].toLowerCase();this.config.has_delimiter=hasDelimiter,-1<firstEntrant.indexOf("name")||-1<firstEntrant.indexOf("email")||-1<firstEntrant.indexOf("nombre")||-1<firstEntrant.indexOf("correo electronico")||-1<firstEntrant.indexOf("nombre")||-1<firstEntrant.indexOf("id")?this.config.has_headers=!0:this.config.has_headers=!1},onCancel:function(){$("#uploadFileModal").modal("hide"),this.lines=[]},onFileUploaded:function(response){this.loading=!1,response.success&&response.data&&response.data.lines&&(this.lines=response.data.lines,this.config.filename=response.data.filename)},onFileUploadedFailed:function(response){this.loading=!1,this.error=!0},getLastEntrant:function(){var index=this.entrants.length-1;return this.entrants[index]},onSave:function(){var request_url="/api/giveaways/create",request_method="POST",data={id:this.giveaway&&this.giveaway.id,type:"random-name",title:this.config.title,has_headers:this.config.has_headers,has_delimiter:this.config.has_delimiter,delimiter:this.config.delimiter,main_field:this.config.main_field,display_field:this.config.display_field,total_participants:this.entrants.length,filename:this.config.filename,source:this.config.source,display_field:this.config.display_field};this.config.filename||(data.entries=JSON.stringify(this.entrants)),this.giveaway&&this.giveaway.id&&(request_url=endpoint="/api/giveaways/update",request_method="PUT"),$.ajax({url:request_url,method:request_method,data:data,dataType:"json"}).done(this.onSaveDone).fail(this.onSaveFail)},onSaveDone:function(r){return console.log(r),r.success?r.success&&r.data&&r.data.id?this.redirectTo("/giveaways/setup/"+r.data.id):void 0:this.showAlert("error",r.error)},onSaveFail:function(r){console.log(r)},onPreviewEntrants:function(r){this.loading=!0,$("#previewModal").modal(),$.ajax({method:"GET",dataType:"json",url:"/api/giveaways/preview",data:{id:this.giveaway.id}}).done(this.onPreviewDone).fail(this.onPreviewFail)},onPreviewDone:function(response){console.log(response),this.loading=!1,this.previewData=response.data},onPreviewFail:function(r){console.log(r),this.loading=!1},onEdit:function(r){this.config.new_title=this.config.title,$("#editModal").modal()},onSaveChanges:function(){this.loading=!0,$.ajax({method:"PUT",dataType:"json",url:"/api/giveaways/update",data:{id:this.giveaway.id,title:this.config.new_title}}).done(this.onSaveChangesDone).fail(this.onSaveChangesFail)},onSaveChangesDone:function(response){this.loading=!1,response.success&&(this.config.title=response.data.title),this.hideModal("editModal")},onSaveChangesFail:function(r){this.loading=!1,this.hideModal("editModal")},goToCheckout(){window.location.href="/"+window.locale+"/giveaways/pay/"+this.giveaway.id},goToApp(){window.location.href="/"+window.locale+"/app/"+this.giveaway.id},onEditEntrants(){this.loading=!0,this.onGetEntrants(),this.openModal("importManuallyModal")},onGetEntrants:function(r){this.loading=!0,$.ajax({method:"GET",dataType:"json",url:"/api/giveaways/entrants",data:{id:this.giveaway.id}}).done(this.onGetEntrantsDone).fail(this.onGetEntrantsFail)},onGetEntrantsDone:function(response){this.loading=!1,this.textarea=response.data.join("\n")},onGetEntrantsFail:function(r){console.log(r),this.loading=!1},updateCount:function(){var lines;this.lines.length?this.totalLines=this.lines.length:(lines=this.form.textarea.split("\n").map(function(item){return item.trim()}).filter(function(item){return""!==item}),this.totalLines=lines.length)},getUniqueArrayElements(array,onlyCount){return u=array.filter(function(e,n){return array.indexOf(e)===n}),onlyCount?(onlyCount=u.length,delete u,onlyCount):lines},getUniqueArrayElementsCount(array){var i=0,uniques=[];if(3e4<array.length)return"-";for(;i<array.length;)-1===uniques.indexOf(array[i])&&uniques.push(array[i]),i++;return uniques.length},onClear:function(){this.form.textarea="",this.updateCount()},onSelectPremium:function(){this.premiumEventSent||(this.premiumEventSent=!0,mixpanel.track("AS_ListGiveawayPremiumSelected"))}}});